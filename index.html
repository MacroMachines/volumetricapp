<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <title>Web Audio API</title>
    <script type="text/javascript" src="js/jquery-1.8.0.min.js"></script>
    <script src="js/jquery-ui.js"></script>
    <link rel="stylesheet" href="css/jquery-ui.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        <div id="vlmArea">Drag with mouse</div>
        <canvas id="meter" height="200"></canvas>
    </div>
 
    <script type="text/javascript">

        $(document).ready(function() {
            vlm.init();
         });

////////////////// VLM application ////////////////
 
var vlm = {};
 
vlm.init = function() {
    vlmIn.init();
    vlmSpectrum.init();
    vlmArea.init();
    vlmMeter.init();
 }

vlm.getAverageVolume = function(array) {
    var values = 0;
    var average;

    var length = array.length;

    // get all the frequency amplitudes
    for (var i = 0; i < length; i++) {
        values += array[i];
    }

    average = values / length;
    return average;
}


////////////////// vlmIn //////////////////////////
// Object caontaining everything related to the 
// incoming audio

var vlmIn = {
    audioContext: null,
    analyser: null,
    microphone: null,
    javascriptNode: null
}

vlmIn.init = function() {
    navigator.webkitGetUserMedia({audio: true}, vlmIn.createAudioNodes,
            function(err) {
                console.error(err);
            }
    )
}

vlmIn.analyseAudio = function() {
    // bincount is fftsize / 2
    freqArray =  new Uint8Array(vlmIn.analyser.frequencyBinCount); //move this out of loop?
    vlmIn.analyser.getByteFrequencyData(freqArray);
    
    //Draw the spectrum to the canvas
    drawSpectrum(freqArray);
}

vlmIn.createAudioNodes = function(stream) {
    vlmIn.audioContext = new AudioContext();
    vlmIn.analyser = vlmIn.audioContext.createAnalyser();
    vlmIn.analyser.smoothingTimeConstant = 0.3;
    //analyser.fftSize = 256;


    vlmIn.microphone = vlmIn.audioContext.createMediaStreamSource(stream);
    vlmIn.microphone.connect(vlmIn.analyser);
    
    vlmIn.microphone.connect(vlmIn.audioContext.destination); //Monitor audio

     // setup a javascript node
     // This will create a ScriptProcessor that is called whenever the 2048 frames have been sampled. Since our data is sampled at 44.1k, this function will be called approximately 21 times a second. 
    vlmIn.javascriptNode = vlmIn.audioContext.createScriptProcessor(2048, 1, 1);
    vlmIn.analyser.connect(vlmIn.javascriptNode);
    vlmIn.javascriptNode.connect(vlmIn.audioContext.destination);

    //COnnect function that analyses audio
    vlmIn.javascriptNode.onaudioprocess = vlmIn.analyseAudio;
}


////////////////// vlmSpectrum //////////////////////////

var vlmSpectrum = {
    width: 1000,
    height: 200,
    canvasContext: $("#canvas").get()[0].getContext("2d")
}

vlmSpectrum.init = function() {
    $("#canvas").attr("width", vlmSpectrum.width);
    $("#canvas").attr("height", vlmSpectrum.height);

    // create a gradient for the fill
    vlmSpectrum.gradient = vlmSpectrum.canvasContext.createLinearGradient(0,0,0,vlmSpectrum.height);
    vlmSpectrum.gradient.addColorStop(0,'#000000');
    vlmSpectrum.gradient.addColorStop(0.25,'#ff0000');
    vlmSpectrum.gradient.addColorStop(0.75,'#ffff00');
    vlmSpectrum.gradient.addColorStop(1,'#ffffff');

    vlmSpectrum.canvasContext.fillStyle=vlmSpectrum.gradient;
}

////////////////// vlmArea //////////////////////////
// The user selected area of the spectrum

var vlmArea = {
    width: vlmSpectrum.width,
    height: vlmSpectrum.height,
    position: {top: 0,left: 0}
}

vlmArea.init = function() {
    $( "#vlmArea" ).width(vlmArea.width);
    $( "#vlmArea" ).height(vlmArea.height);

    $( "#vlmArea" ).resizable({
        containment: $('canvas'),
        handles: "all",
        stop: function(event, ui) {
            var w = $(this).width();
            var h = $(this).height();
            console.log('w', w, "h", h); 
            //Size excluding the border
            vlmArea.width = w;
            vlmArea.height = h;
            vlmArea.position.left = ui.position.left;
            vlmArea.position.top = ui.position.top;

        }
    });

    $( "#vlmArea" ).draggable({
        containment: $('canvas'),
        stop: function(event, ui){
            console.log(ui.position.top, ui.position.left)
            //position relative to the container
            vlmArea.position.left = ui.position.left;
            vlmArea.position.top = ui.position.top;
        }
   });
}

////////////////// vlmMeter //////////////////////////
// The output volume meter

var vlmMeter = {
    meterContext: $("#meter").get()[0].getContext("2d"),
    heightInPixels: 200
};

vlmMeter.init = function() {
    vlmMeter.gradient = vlmMeter.meterContext.createLinearGradient(0,0,0,$("#meter").attr("height"));
    vlmMeter.gradient.addColorStop(0,'#000000');
    vlmMeter.gradient.addColorStop(0.25,'#ff0000');
    vlmMeter.gradient.addColorStop(0.75,'#ffff00');
    vlmMeter.gradient.addColorStop(1,'#ffffff');
}

//normVol is a value in the 0-1 range
vlmMeter.drawVolumeter = function(normVol) {
    // clear the current state
    vlmMeter.meterContext.clearRect(20, 0, 25, $("#meter").attr("height"));

    // set the fill style
    vlmMeter.meterContext.fillStyle=vlmSpectrum.gradient;
    var top = vlmMeter.heightInPixels-(normVol*vlmMeter.heightInPixels);
    // create the meters
    vlmMeter.meterContext.fillRect(20,top,25,vlmMeter.heightInPixels);
}

///////////////////




        function drawSpectrum(array) {
            // clear the canvas
            vlmSpectrum.canvasContext.clearRect(0, 0, 1000, 325);

            var sliceWidth = 2; //vlmSpectrum.width * 1.0 / analyser.frequencyBinCount;
            var x = 0;
            var meterSum = [];

            for ( var i = 0; i < (array.length); i++ ){
                    var value = array[i];
 
                    //Nomalize spectrum value
                    var normV = value / 256.0;
                    //Calculate y position - the top of the spectrum bar
                    var y = vlmSpectrum.height - (normV * vlmSpectrum.height);

                    //Calculate the volumeter
                    var areaBottom = vlmArea.position.top+vlmArea.height;
                    if (x >= vlmArea.position.left && 
                            x+sliceWidth <= vlmArea.position.left + vlmArea.width &&
                            y <= areaBottom
                        ) {

                        //get normalized value of the current spectrum value relative to the selected area
                        var add = 1-((y-vlmArea.position.top)/vlmArea.height);
                        add = add > 1 ? 1 : add; //cap value at 1
                        //console.log(add);
                        meterSum.push(add);
                    }

                    x += sliceWidth;

                    //vlmSpectrum.canvasContext.fillRect(bar.x,bar.y,bar.w,bar.h);
                    vlmSpectrum.canvasContext.fillRect(x, y, sliceWidth*0.8, vlmSpectrum.height)

            }
            var meterVol = vlm.getAverageVolume(meterSum);
            vlmMeter.drawVolumeter(meterVol);
        }

    </script>

</body>
</html>